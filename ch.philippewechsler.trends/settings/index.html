<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <!--<script src='https://cdn.staticaly.com/gh/robertklep/homey-mocks/v0.0.4/homey-settings-mock.js'></script>-->

    <script src="js/jquery-3.5.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/chartjs-plugin-annotation.min.js"></script>
    <script src="js/chartjs-plugin-dragdata.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/animation.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
</head>

<body>

    <div class="homeyAnimation"></div>

    <nav>
        <div class="nav nav-tabs glass-dark" id="nav-tab" role="tablist"
            style="margin-left: 5px; margin-top: 5px; margin-right: 5px;">
            <a class="nav-item nav-link active" id="nav-live-tab" data-toggle="tab" href="#nav-live" role="tab"
                aria-controls="nav-contact" aria-selected="false">Live</a>
            <a class="nav-item nav-link" id="nav-about-tab" data-toggle="tab" href="#nav-about" role="tab"
                aria-controls="nav-contact" aria-selected="false">About</a>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-live" role="tabpanel" aria-labelledby="nav-live-tab">
            <!--live tab begin-->
            <div class="card glass" style="margin-top: 10px;">
                <div class="card-body">

                    <div class="row">
                        <div class="col">
                            <label>Insight</label>
                            <div class="dropdown dropup">
                                <button class="btn btn-primary" type="button" id="insightDropdownButton"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                    style="width: 100%; text-align: left;">
                                    Insight 1
                                </button>
                                <div class="dropdown-menu" aria-labelledby="pollingDropDown" id="insightDropdownMenu">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Filter</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search..." id="insightFilter">
                                <div class="input-group-prepend">
                                    <button type="button" class="btn btn-primary" id="insightRefreshButton"
                                        style="border-top-right-radius: 4px; border-bottom-right-radius: 4px;">
                                        <span class="fa fa-refresh"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Scope</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="scope" min="1" id="scope">
                                <div class="input-group-prepend">
                                    <div class="dropdown dropup">
                                        <button class="btn btn-primary dropdown-toggle" type="button"
                                            id="scopeUnitsButton" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false"
                                            style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                            Minutes
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="pollingDropDown">
                                            <a class="dropdown-item" href="#">Minutes</a>
                                            <a class="dropdown-item" href="#">Hours</a>
                                            <a class="dropdown-item" href="#">Days</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm">
                            <canvas id="chart" width="400" height="400">
                            </canvas>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label>Trend</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label>Standard deviation</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label>Average</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label>Median</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label>Minimum</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label>Maximum</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!--live tab end-->
        </div>
        <div class="tab-pane fade" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab">
            <!--about tab begin-->
            <div class="card glass" style="margin-top: 10px;">
                <img class="card-img-top" src="images/icon.svg"
                    style="padding-left: 15px; padding-right: 15px; padding-top: 15px;">
                <div class="card-body">
                    <h5 class="card-title">Insight Trends for Homey v1.0.0</h5>
                    <h3 class="card-title">Â© Philippe Wechsler 2021</h3>
                    <div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a>
                        from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
                </div>
            </div>
            <!--about tab end-->
        </div>
    </div>

    <script type="text/javascript">

        function onHomeyReady(Homey) {

            if (Homey.isMock) {
                //Homey.alert('Warning: Homey is mocked only!!!')
                let store = {};
                Homey.addRoutes([
                    {
                        method: 'GET',
                        path: '/insights',
                        public: false,
                        fn: function (args, callback) {
                            console.log('search insights: ' + args.query.search)
                            return callback(null, [{
                                name: 'temperature 1', description: 'device 1', id: '1', uri: 'uri', type: 'number', units: '%'
                            }, {
                                name: 'temperature 2', description: 'device 2', id: '1', uri: 'uri', type: 'number', units: '%'
                            }, {
                                name: 'temperature 3', description: 'device 3', id: '1', uri: 'uri', type: 'number', units: '%'
                            }])
                        }
                    },
                    {
                        method: 'GET',
                        path: '/trends',
                        public: false,
                        fn: async function (args, callback) {
                            await Homey.app.getTrends(args.query.id, args.query.uid, args.query.scope, args.query.scopeUnit, (err, result) => {
                                if (err) {
                                    callback(err, null)
                                } else {
                                    callback(null, result)
                                }
                            })
                        }
                    }
                ]);
            }

            const insightDropdownButton = document.getElementById('insightDropdownButton');
            const insightDropdownMenu = document.getElementById('insightDropdownMenu');
            const insightFilter = document.getElementById('insightFilter');
            const insightRefreshButton = document.getElementById('insightRefreshButton');
            const scope = document.getElementById('scope');
            const scopeUnitsButton = document.getElementById('scopeUnitsButton');

            insightFilter.addEventListener('input', (e) => { loadInsights() });
            insightRefreshButton.addEventListener('click', (e) => { loadInsights() });

            let selectedInsight = null;

            function loadInsights() {
                insightDropdownButton.innerText = 'loading';
                insightDropdownButton.disabled = true;
                Homey.api('GET', '/insights?search=' + insightFilter.value, {}, function (error, data) {
                    insightDropdownButton.disabled = false;
                    if (error) {
                        insightDropdownButton.innerText = 'error';
                    } else {
                        let html = '';
                        for (var i = 0; i < data.length; i++) {
                            html += `
                                <a class="dropdown-item" href="#" onclick="selectInsight({title:'${data[i].name}',id:'${data[i].id}',uri:'${data[i].uri}'})">${data[i].name}</a>
                            `;
                        }
                        insightDropdownMenu.innerHTML = html;
                    }
                    window.selectInsight(null);
                })
            }

            function loadTrends() {

            }

            window.selectInsight = function (insight) {
                selectedInsight = insight;
                if (selectedInsight == null) {
                    insightDropdownButton.innerText = 'please select';
                } else {
                    insightDropdownButton.innerText = selectedInsight.title;
                }
            }

            Homey.ready()

            loadInsights();

        }

    </script>
</body>

</html>